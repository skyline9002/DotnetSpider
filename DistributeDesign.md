## Design

```
                                                               +--------+
                                                        +----->| Node 1 |
                                                        |      +--------+
                                                        |
+--------------+                  +---------+           |      +--------+
| Scheduler.NET|<------HTTP------>| Broker  |<--SignalR-|----->| Node 2 |
+--------------+                  +----^----+           |      +--------+
                                       |                |
                                     SignalR            |      +--------+
                                       |                +----->| Node 1 |
                               +-------+---------+             +--------+
                               |                 |
                         +-----v----+     +------v---+
                         | Worker 1 |     | Worker 2 |
                         +----------+     +----------+
```



## Modules

### Node

Node send heartbeat to broker and receive message from broker via websocket.

```
+---------------------------------------------------+ 
|                      Node                         |
+-------------------+--------------+----------------+
| + Id              | GUID         | PRIMARY        |
+-------------------+--------------+----------------+
| + IPAddress       | STRING(50)   |                |
+-------------------+--------------+----------------+
| + ProcessorCount  | INT          |                |
+-------------------+--------------+----------------+
| + Group           | STRING(100)  |                |
+-------------------+--------------+----------------+
| + OperatingSystem | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Memory          | INT          |                |
+-------------------+--------------+----------------+
| + IsEnabled       | BOOL         |                |
+-------------------+--------------+----------------+
| + LastOnlineTime  | DATETIME     |                |
+-------------------+--------------+----------------+

+---------------------------------------------------+ 
|                    NodeHeartbeat                  |
+-------------------+--------------+----------------+
| + Id              | INT          | PRIMARY, AI    |
+-------------------+--------------+----------------+
| + NodeId          | GUID         |                |
+-------------------+--------------+----------------+
| + ProcessCount    | INT          |                |
+-------------------+--------------+----------------+
| + Cpu             | INT          |                |
+-------------------+--------------+----------------+
| + FreeMemory      | INT          |                |
+-------------------+--------------+----------------+
| + CreationTime    | DATETIME     |                |
+-------------------+--------------+----------------+
```

### Broker

```
=======================BlockJob======================
+---------------------------------------------------+ 
|                      BlockJob                     |
+-------------------+--------------+----------------+
| + Id              | GUID         | PRIMARY        |
+-------------------+--------------+----------------+
| + Name            | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Cron            | STRING(50)   |                |
+-------------------+--------------+----------------+
| + FullClassName   | STRING(100)  |                |
+-------------------+--------------+----------------+
| + Arguments       | STRING(500)  |                |
+-------------------+--------------+----------------+
| + Description     | STRING(500)  |                |
+-------------------+--------------+----------------+
| + IsEnabled       | BOOL         |                |
+-------------------+--------------+----------------+
| + IsDeleted       | BOOL         |                |
+-------------------+--------------+----------------+

Node is used as distributed downloader for block job, start request builder & processor & pipeline is a worker. 

=======================ApplicationJob================

+---------------------------------------------------+ 
|                      ApplicationJob               |
+-------------------+--------------+----------------+
| + Id              | GUID         | PRIMARY        |
+-------------------+--------------+----------------+
| + Name            | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Cron            | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Package         | STRING(100)  |                |
+-------------------+--------------+----------------+
| + Application     | STRING(100)  |                |
+-------------------+--------------+----------------+
| + Arguments       | STRING(500)  |                |
+-------------------+--------------+----------------+
| + NodeCount       | INT          |                |
+-------------------+--------------+----------------+
| + NodeGroup       | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Os              | STRING(50)   |                |
+-------------------+--------------+----------------+
| + Description     | STRING(500)  |                |
+-------------------+--------------+----------------+
| + IsEnabled       | BOOL         |                |
+-------------------+--------------+----------------+
| + IsDeleted       | BOOL         |                |
+-------------------+--------------+----------------+

Node is used as a agent for application job.

=======================Worker========================

+---------------------------------------------------+ 
|                      Worker                       |
+-------------------+--------------+----------------+
| + FullClassName   | STRING(100)  | PRIMARY        |
+-------------------+--------------+----------------+
| + ConnectionId    | STRING(50)   | PRIMARY        |
+-------------------+--------------+----------------+
| + IsDisconnected  | BOOL         |                |
+-------------------+--------------+----------------+
| + CreationTime    | DATETIME     |                |
+-------------------+--------------+----------------+
| + DisconnectTime  | DATETIME     |                |
+-------------------+--------------+----------------+

=======================Block=========================

+---------------------------------------------------+ 
|                      Block                        |
+-------------------+--------------+----------------+
| + BlockId         | GUID         | PRIMARY        |
+-------------------+--------------+----------------+
| + Identity        | GUID         | INDEX_IDENTITY |
+-------------------+--------------+----------------+
| + SwtichIpPattern | STRING(100)  |                |
+-------------------+--------------+----------------+
| + Status          | ENUM         |                |
+-------------------+--------------+----------------+
| + CreationTime    | DATETIME     |                |
+-------------------+--------------+----------------+

Block status: ready (1), using (2), success(4), failed(8), retry(16)

===================BlockStatusHistory================

+---------------------------------------------------+ 
|                  BlockStatusHistory               |
+-------------------+--------------+----------------+
| + Id              | INT          | PRIMARY, AI    |
+-------------------+--------------+----------------+
| + BlockId         | GUID         | INDEX_BLOCKID  |
+-------------------+--------------+----------------+
| + Status          | ENUM         |                |
+-------------------+--------------+----------------+
| + Detail          | STRING(MAX)  |                |
+-------------------+--------------+----------------+
| + CreationTime    | DATETIME     |                |
+-------------------+--------------+----------------+

=======================Running=======================

+---------------------------------------------------+ 
|                      Running                      |
+-------------------+--------------+----------------+
| + JobId           | GUID         | PRIMARY        |
+-------------------+--------------+----------------+
| + Identity        | GUID         | INDEX_IDENTITY |
+-------------------+--------------+----------------+
| + Arguments       | STRING(500)  |                |
+-------------------+--------------+----------------+
| + Priority        | INT          |                |
+-------------------+--------------+----------------+
| + Priority        | INT          |                |
+-------------------+--------------+----------------+
| + CreationTime    | DATETIME     |                |
+-------------------+--------------+----------------+

 +-------------------+
 | ICrawlerService    |
 +-------------------+
 | Add|
 +-------------------+

 +-------------------+
 | IWorkerService    |
 +-------------------+
 | Watch(string name)|
 +-------------------+

```

### 角色

**Broker**

+ 分发请求块（Blockoutput）： POST http://broker/node/heartbeat
+ 接收分布式下载器的回传数据 (Blockinput): POST http://broker/node/block
+ 接收 Request 打包成 Block, 插入 Request 队列: POST http://broker/requestqueue/{identity}
+ 通过 Identity 查询已经完成的 Request 以 Block 为单位 : GET http://broker/requestqueue/{identity}

Entities
----------------------------

#### Running

| Column | DataType | Value| Key |
|:---|:---|:---|:---|
|JobId|VARCHAR(32)| GUID | Primary |
|Identity| VARCHAR(32)| GUID | Primary |
|ThreadNum| INT | 2 |  |
|Site| VARCHAR(MAX)|  |  |
|Priority| INT| 0 |  |
|PopTimes| INT| 0 |  |
|BlockCount |INT| 10| |

##### 任务管理

1. Portal 通过 Broker API 添加一个任务
		
		NAME: TASK1
		CRON: */5 * * * *
		PROCESSOR: Console.SampleProcessor
		ARGUMENTS:
		DESCRIPTION: This is a test task.

+ 通过 Scheduler.NET API 添加任务并获得返回的 SchedulerNetId, 如果成功则执行下一步操作，失败则抛异常
+ 添加 Job 信息到数据库中

2. Portal 通过 Broker API 修改一个任务

+ 通过 Scheduler.NET API 修改任务， 如果修改成功则执行下一步操作，失败则抛异常
+ 修改数据库中的 Job 信息

3. Portal 通过 Broker API 删除一个任务

+ 通过 Scheduler.NET API 删除任务， 如果删除成功则执行下一步操作，失败则抛异常
+ 从数据库中删除 Job 信息

##### 任务执行

1. 启动 Wroker 实例





